
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../network-weapon/">
      
      
        <link rel="next" href="../window-tiler/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.49">
    
    
      
        <title>RewindableStateMachine - netfox</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.6f8fc17f.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/mkdocs_puml/puml.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#rewindablestatemachine" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="netfox" class="md-header__button md-logo" aria-label="netfox" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            netfox
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              RewindableStateMachine
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="netfox" class="md-nav__button md-logo" aria-label="netfox" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    netfox
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../upgrading/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Upgrading netfox
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    netfox
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            netfox
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tutorials
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../netfox/tutorials/responsive-player-movement/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Responsive player movement
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../netfox/tutorials/configuring-properties-from-code/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuring properties from code
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../netfox/tutorials/rollback-caveats/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rollback caveats
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../netfox/tutorials/interpolation-caveats/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Interpolation caveats
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Concepts
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Concepts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../netfox/concepts/servers-clients-ownership/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Servers, clients, and ownership
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../netfox/concepts/authoritative-servers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Authoritative servers
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Guides
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../netfox/guides/logging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Logging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../netfox/guides/network-time/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NetworkTime
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../netfox/guides/network-time-synchronizer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NetworkTimeSynchronizer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../netfox/guides/network-events/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NetworkEvents
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../netfox/guides/interpolators/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Interpolators
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../netfox/guides/property-paths/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Property paths
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../netfox/guides/network-rollback/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NetworkRollback
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../netfox/guides/network-performance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NetworkPerformance
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Nodes
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            Nodes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../netfox/nodes/tick-interpolator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TickInterpolator
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../netfox/nodes/rollback-synchronizer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RollbackSynchronizer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../netfox/nodes/state-synchronizer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    StateSynchronizer
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    netfox.noray
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            netfox.noray
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Guides
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../netfox.noray/guides/noray/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Noray
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../netfox.noray/guides/packet-handshake/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PacketHandshake
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    netfox.extras
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            netfox.extras
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" checked>
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Guides
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../base-net-input/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BaseNetInput
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../network-weapon/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NetworkWeapon
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    RewindableStateMachine
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    RewindableStateMachine
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#creating-a-state-machine" class="md-nav__link">
    <span class="md-ellipsis">
      Creating a state machine
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementing-states" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing states
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#display-state-vs-state" class="md-nav__link">
    <span class="md-ellipsis">
      Display State vs State
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caveats" class="md-nav__link">
    <span class="md-ellipsis">
      Caveats
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../window-tiler/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    WindowTiler
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#creating-a-state-machine" class="md-nav__link">
    <span class="md-ellipsis">
      Creating a state machine
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementing-states" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing states
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#display-state-vs-state" class="md-nav__link">
    <span class="md-ellipsis">
      Display State vs State
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caveats" class="md-nav__link">
    <span class="md-ellipsis">
      Caveats
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="rewindablestatemachine">RewindableStateMachine</h1>
<p>Rollback-aware state machine implementation.</p>
<p>State machines are often used in games to implement different behaviors.
However, most implementations are not prepared for rollbacks. This class
provides an extensible implementation that can be used alongside a
<a href="../../../netfox/nodes/rollback-synchronizer/">RollbackSynchronizer</a>.</p>
<p>For a full example, see <a href="https://github.com/foxssake/netfox/tree/main/examples/multiplayer-state-machine">multiplayer-state-machine</a>.</p>
<h2 id="creating-a-state-machine">Creating a state machine</h2>
<p>The first step is to add the RewindableStateMachine to your scene. It also
requires a RollbackSynchronizer that manages its <code>state</code> property. Unless these
conditions are satisfied, an editor warning will be displayed.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Editor warnings are only updated when the node tree changes. Configuration
changes don't trigger an update. You may need to reload the scene after
fixing a warning, or make a tree change, like deleting and re-adding a node
by cutting and pasting.</p>
</div>
<p><img alt="RewindableStateMachine with
RollbackSynchronizer" src="../../assets/rewindable-state-machine-rollback.png" /></p>
<p>Notice the RollbackSynchronizer added as a sibling to the
RewindableStateMachine, and having its <code>state</code> property configured.</p>
<h2 id="implementing-states">Implementing states</h2>
<p>States are where the custom gameplay logic can be implemented. Each state must
be an extension of the RewindableState class, and added as a child to the
RewindableStateMachine.</p>
<p>States react to the game world using the following callbacks:</p>
<ul>
<li><code>tick(delta, tick, is_fresh)</code> is called for every rollback tick.</li>
<li><code>enter(previous_state, tick)</code> is called when entering the state.</li>
<li><code>exit(next_state, tick)</code> is called when exiting the state.</li>
<li><code>can_enter(previous_state)</code> is called before entering the state. The state is
  only entered if this method returns true.</li>
<li><code>display_enter(previous_state, tick)</code> is called before displaying the state.</li>
<li><code>display_exit(next_state, tick)</code> is called before displaying a different
  state.</li>
</ul>
<p>You can override any of these callbacks to implement your custom behaviors.</p>
<p>For example, the snippet below implements an idle state, that transitions to
other states based on movement inputs:</p>
<div class="highlight"><pre><span></span><code><span class="k">extends</span><span class="w"> </span><span class="n">RewindableState</span>

<span class="err">@</span><span class="k">export</span><span class="w"> </span><span class="k">var</span><span class="w"> </span><span class="n">input</span><span class="p">:</span><span class="w"> </span><span class="n">PlayerInputStateMachine</span>

<span class="k">func</span><span class="w"> </span><span class="n">tick</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="n">tick</span><span class="p">,</span><span class="w"> </span><span class="n">is_fresh</span><span class="p">):</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">input</span><span class="o">.</span><span class="n">movement</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb nb-Type">Vector3</span><span class="o">.</span><span class="n">ZERO</span><span class="p">:</span>
<span class="w">        </span><span class="n">state_machine</span><span class="o">.</span><span class="n">transition</span><span class="p">(</span><span class="o">&amp;</span><span class="s2">&quot;Move&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">elif</span><span class="w"> </span><span class="n">input</span><span class="o">.</span><span class="n">jump</span><span class="p">:</span>
<span class="w">        </span><span class="n">state_machine</span><span class="o">.</span><span class="n">transition</span><span class="p">(</span><span class="o">&amp;</span><span class="s2">&quot;Jump&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Transitions are based on <em>node names</em>, i.e. calling <code>transition(&amp;"Move")</code> will
transition to a state node called <em>Move</em>. </p>
<p><img alt="RewindableStates under a state
machine" src="../../assets/rewindable-state-children.png" /></p>
<p>States must be added as children under a RewindableStateMachine to work.</p>
<h2 id="display-state-vs-state">Display State vs State</h2>
<p>There's two sets of callbacks for state transition - <code>enter()</code>/<code>exit()</code> and
<code>display_enter()</code>/<code>display_exit()</code>.</p>
<p>The <code>enter()</code>/<code>exit()</code> callbacks are intended for implementing game logic. The
<code>display_enter()</code>/<code>display_exit()</code> are intended for implementing presentation
logic - visuals, animations, sound effects, etc.</p>
<p>The same applies to <code>on_state_changed</code> vs. <code>on_display_state_changed</code>.</p>
<p>Let's take an example. The game is currently on tick @8. It needs to re-run
ticks @0 to @8 during rollback. In these ticks, the player moves a bit,
performs a jump, and then stops after moving a bit more:</p>
<div class='puml-container'><div class="puml light" style="display: block"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="96px" preserveAspectRatio="xMidYMid meet" style="width:487px;height:96px;background:#FFFFFF;" version="1.1" viewBox="0 0 487 96" width="487px" zoomAndPan="magnify" class="diagram"><defs/><g><line style="stroke:#333333;stroke-width:0.5;" x1="10" x2="10" y1="10" y2="66.2969"/><line style="stroke:#333333;stroke-width:0.5;" x1="470" x2="470" y1="10" y2="66.2969"/><line style="stroke:#333333;stroke-width:0.5;stroke-dasharray:3.0,5.0;" x1="15" x2="15" y1="10" y2="66.2969"/><line style="stroke:#333333;stroke-width:0.5;stroke-dasharray:3.0,5.0;" x1="65" x2="65" y1="10" y2="66.2969"/><line style="stroke:#333333;stroke-width:0.5;stroke-dasharray:3.0,5.0;" x1="115" x2="115" y1="10" y2="66.2969"/><line style="stroke:#333333;stroke-width:0.5;stroke-dasharray:3.0,5.0;" x1="165" x2="165" y1="10" y2="66.2969"/><line style="stroke:#333333;stroke-width:0.5;stroke-dasharray:3.0,5.0;" x1="215" x2="215" y1="10" y2="66.2969"/><line style="stroke:#333333;stroke-width:0.5;stroke-dasharray:3.0,5.0;" x1="265" x2="265" y1="10" y2="66.2969"/><line style="stroke:#333333;stroke-width:0.5;stroke-dasharray:3.0,5.0;" x1="315" x2="315" y1="10" y2="66.2969"/><line style="stroke:#333333;stroke-width:0.5;stroke-dasharray:3.0,5.0;" x1="365" x2="365" y1="10" y2="66.2969"/><line style="stroke:#333333;stroke-width:0.5;stroke-dasharray:3.0,5.0;" x1="415" x2="415" y1="10" y2="66.2969"/><line style="stroke:#333333;stroke-width:0.5;stroke-dasharray:3.0,5.0;" x1="465" x2="465" y1="10" y2="66.2969"/><line style="stroke:#333333;stroke-width:0.5;" x1="10" x2="470" y1="10" y2="10"/><text fill="#333333" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="50.0322" x="15" y="22.9951">Player</text><line style="stroke:#333333;stroke-width:0.5;" x1="10" x2="66.0322" y1="27.2969" y2="27.2969"/><line style="stroke:#333333;stroke-width:0.5;" x1="66.0322" x2="76.0322" y1="27.2969" y2="10"/><polygon fill="#E2E2F0" points="27,32.2969,53,32.2969,65,44.2969,53,56.2969,27,56.2969,15,44.2969" style="stroke:#006400;stroke-width:1.5;"/><polygon fill="#E2E2F0" points="77,32.2969,153,32.2969,165,44.2969,153,56.2969,77,56.2969,65,44.2969" style="stroke:#006400;stroke-width:1.5;"/><polygon fill="#E2E2F0" points="177,32.2969,253,32.2969,265,44.2969,253,56.2969,177,56.2969,165,44.2969" style="stroke:#006400;stroke-width:1.5;"/><polygon fill="#E2E2F0" points="277,32.2969,403,32.2969,415,44.2969,403,56.2969,277,56.2969,265,44.2969" style="stroke:#006400;stroke-width:1.5;"/><polygon fill="#E2E2F0" points="427,32.2969,465,32.2969,465,56.2969,427,56.2969,415,44.2969" style="stroke:#E2E2F0;stroke-width:1.5;"/><path d="M465,32.2969 L427,32.2969 L415,44.2969 L427,56.2969 L465,56.2969 " fill="#E2E2F0" style="stroke:#006400;stroke-width:1.5;"/><text fill="#333333" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="25.3066" x="27.3467" y="48.4512">Idle</text><text fill="#333333" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="49.2539" x="90.373" y="48.4512">Moving</text><text fill="#333333" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="55.3477" x="187.3262" y="48.4512">Jumping</text><text fill="#333333" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="49.2539" x="315.373" y="48.4512">Moving</text><text fill="#333333" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="25.3066" x="427" y="48.4512">Idle</text><line style="stroke:#333333;stroke-width:2;" x1="15" x2="15" y1="66.2969" y2="71.2969"/><line style="stroke:#333333;stroke-width:2;" x1="65" x2="65" y1="66.2969" y2="71.2969"/><line style="stroke:#333333;stroke-width:2;" x1="115" x2="115" y1="66.2969" y2="71.2969"/><line style="stroke:#333333;stroke-width:2;" x1="165" x2="165" y1="66.2969" y2="71.2969"/><line style="stroke:#333333;stroke-width:2;" x1="215" x2="215" y1="66.2969" y2="71.2969"/><line style="stroke:#333333;stroke-width:2;" x1="265" x2="265" y1="66.2969" y2="71.2969"/><line style="stroke:#333333;stroke-width:2;" x1="315" x2="315" y1="66.2969" y2="71.2969"/><line style="stroke:#333333;stroke-width:2;" x1="365" x2="365" y1="66.2969" y2="71.2969"/><line style="stroke:#333333;stroke-width:2;" x1="415" x2="415" y1="66.2969" y2="71.2969"/><line style="stroke:#333333;stroke-width:2;" x1="465" x2="465" y1="66.2969" y2="71.2969"/><line style="stroke:#333333;stroke-width:2;" x1="15" x2="465" y1="66.2969" y2="66.2969"/><text fill="#333333" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="6.9985" x="11.5007" y="82.5073">0</text><text fill="#333333" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="6.9985" x="61.5007" y="82.5073">1</text><text fill="#333333" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="6.9985" x="161.5007" y="82.5073">3</text><text fill="#333333" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="6.9985" x="261.5007" y="82.5073">5</text><text fill="#333333" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="6.9985" x="411.5007" y="82.5073">8</text></g></svg></div></div>

<p>This will trigger the following state changes:</p>
<ul>
<li>Tick@1: Idle -&gt; Moving</li>
<li>Tick@3: Moving -&gt; Jumping</li>
<li>Tick@5: Jumping -&gt; Moving</li>
<li>Tick@8: Moving -&gt; Idle</li>
</ul>
<p>For each of the above, the <code>on_state_changed</code> signal will be emitted, and the
<code>enter()</code>/<code>exit()</code> callbacks will be triggered.</p>
<p>This makes the above callbacks ideal for game logic, e.g. adding an upward
velocity to the player when they enter the <code>Jumping</code> state.</p>
<p>Note that the <em>displayed</em> state does not change. Before the rollback loop, the
player's state was <code>Idle</code>. After the rollback loop, the player's state is also
<code>Idle</code>. Even though the player has ran and performed a jump, it wouldn't make
sense to change their animation or play any sound effect.</p>
<p>Let's take a different rollback example:</p>
<div class='puml-container'><div class="puml light" style="display: block"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="96px" preserveAspectRatio="xMidYMid meet" style="width:294px;height:96px;background:#FFFFFF;" version="1.1" viewBox="0 0 294 96" width="294px" zoomAndPan="magnify" class="diagram"><defs/><g><line style="stroke:#333333;stroke-width:0.5;" x1="10" x2="10" y1="10" y2="66.2969"/><line style="stroke:#333333;stroke-width:0.5;" x1="270" x2="270" y1="10" y2="66.2969"/><line style="stroke:#333333;stroke-width:0.5;stroke-dasharray:3.0,5.0;" x1="15" x2="15" y1="10" y2="66.2969"/><line style="stroke:#333333;stroke-width:0.5;stroke-dasharray:3.0,5.0;" x1="65" x2="65" y1="10" y2="66.2969"/><line style="stroke:#333333;stroke-width:0.5;stroke-dasharray:3.0,5.0;" x1="115" x2="115" y1="10" y2="66.2969"/><line style="stroke:#333333;stroke-width:0.5;stroke-dasharray:3.0,5.0;" x1="165" x2="165" y1="10" y2="66.2969"/><line style="stroke:#333333;stroke-width:0.5;stroke-dasharray:3.0,5.0;" x1="215" x2="215" y1="10" y2="66.2969"/><line style="stroke:#333333;stroke-width:0.5;stroke-dasharray:3.0,5.0;" x1="265" x2="265" y1="10" y2="66.2969"/><line style="stroke:#333333;stroke-width:0.5;" x1="10" x2="270" y1="10" y2="10"/><text fill="#333333" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="50.0322" x="15" y="22.9951">Player</text><line style="stroke:#333333;stroke-width:0.5;" x1="10" x2="66.0322" y1="27.2969" y2="27.2969"/><line style="stroke:#333333;stroke-width:0.5;" x1="66.0322" x2="76.0322" y1="27.2969" y2="10"/><polygon fill="#E2E2F0" points="27,32.2969,153,32.2969,165,44.2969,153,56.2969,27,56.2969,15,44.2969" style="stroke:#006400;stroke-width:1.5;"/><polygon fill="#E2E2F0" points="177,32.2969,203,32.2969,215,44.2969,203,56.2969,177,56.2969,165,44.2969" style="stroke:#006400;stroke-width:1.5;"/><polygon fill="#E2E2F0" points="227,32.2969,265,32.2969,265,56.2969,227,56.2969,215,44.2969" style="stroke:#E2E2F0;stroke-width:1.5;"/><path d="M265,32.2969 L227,32.2969 L215,44.2969 L227,56.2969 L265,56.2969 " fill="#E2E2F0" style="stroke:#006400;stroke-width:1.5;"/><text fill="#333333" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="49.2539" x="65.373" y="48.4512">Moving</text><text fill="#333333" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="25.3066" x="177.3467" y="48.4512">Idle</text><text fill="#333333" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="55.3477" x="227" y="48.4512">Jumping</text><line style="stroke:#333333;stroke-width:2;" x1="15" x2="15" y1="66.2969" y2="71.2969"/><line style="stroke:#333333;stroke-width:2;" x1="65" x2="65" y1="66.2969" y2="71.2969"/><line style="stroke:#333333;stroke-width:2;" x1="115" x2="115" y1="66.2969" y2="71.2969"/><line style="stroke:#333333;stroke-width:2;" x1="165" x2="165" y1="66.2969" y2="71.2969"/><line style="stroke:#333333;stroke-width:2;" x1="215" x2="215" y1="66.2969" y2="71.2969"/><line style="stroke:#333333;stroke-width:2;" x1="265" x2="265" y1="66.2969" y2="71.2969"/><line style="stroke:#333333;stroke-width:2;" x1="15" x2="265" y1="66.2969" y2="66.2969"/><text fill="#333333" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="6.9985" x="11.5007" y="82.5073">5</text><text fill="#333333" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="6.9985" x="161.5007" y="82.5073">8</text><text fill="#333333" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="6.9985" x="211.5007" y="82.5073">9</text></g></svg></div></div>

<p>In this case, the display state <em>did</em> change. Before the rollback loop, the
player's state was <code>Moving</code>. After the rollback loop, the player's state is
<code>Jumping</code>. It would make sense to change the player's animation and play a
jumping sound effect.</p>
<p>This can be done by using the display state callbacks - the
<code>on_display_state_changed</code> signal, and the <code>display_enter()</code>/<code>display_exit()</code>
methods.</p>
<h2 id="caveats">Caveats</h2>
<p>RewindableStateMachine runs in the <a href="../../../netfox/guides/network-rollback/#network-rollback-loop">rollback tick loop</a>, which means that all
the <a href="../../../netfox/tutorials/rollback-caveats/">Rollback Caveats</a> apply.</p>
<p>In addition, rollback ticks are only ran for nodes that have known inputs for
the given tick, and <em>need</em> to be simulated - either on the server to determine
the new state, or on the client to predict. In practice, ticks are usually only
ran on the host owning state and the client owning inputs. The rest of the
peers use the state broadcast by the host.</p>
<p><strong>This means that transition callbacks are not always ran.</strong> This is by design
and expected ( see <a href="https://github.com/foxssake/netfox/issues/327#issuecomment-2491251374">#327</a> ).</p>
<p>As a best practice, in the <code>enter()</code>, <code>exit()</code> callbacks and the
<code>on_state_changed</code> signal, only change game state - i.e. properties that are
configured as state in <a href="../../../netfox/nodes/rollback-synchronizer/">RollbackSynchronizer</a>.</p>
<p>To update visuals - e.g. change animation, spawn effects, etc. -, use either
the <code>on_display_state_changed</code> signal, or the <code>display_enter()</code> and
<code>display_exit()</code> callbacks to react to state transitions.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.88dd0f4e.min.js"></script>
      
        <script src="../../../assets/mkdocs_puml/puml.js"></script>
      
    
  </body>
</html>